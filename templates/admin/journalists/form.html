{% extends "admin/base.html" %}

{% block title %}{% if journalist %}{{ _('edit') }}{% else %}{{ _('create') }}{% endif %} {{ _('journalist') }}{% endblock %}
{% block header %}{% if journalist %}{{ _('edit_journalist') }}{% else %}{{ _('create_journalist') }}{% endif %}{% endblock %}
{% block subheader %}{% if journalist %}{% if current_lang == 'fr' %}Modifiez les paramètres du journaliste{% else %}Edit journalist settings{% endif %}{% else %}{% if current_lang == 'fr' %}Créez un nouveau journaliste IA{% else %}Create a new AI journalist{% endif %}{% endif %}{% endblock %}

{% block content %}
<div class="max-w-3xl">
    <a href="{{ url_for('journalists.index') }}" class="inline-flex items-center text-gray-600 hover:text-gray-800 mb-6">
        <i class="fas fa-arrow-left mr-2"></i>{{ _('back') }}
    </a>
    
    {% if journalist and journalist.photo_url %}
    <div class="mb-6 flex items-center gap-4 p-4 bg-primary-50 rounded-2xl border border-primary-100">
        <img src="{{ journalist.photo_url }}" alt="{{ journalist.name }}" class="w-16 h-16 rounded-lg object-cover">
        <div>
            <h2 class="text-lg font-semibold text-gray-800">{{ journalist.name }}</h2>
            <p class="text-sm text-gray-600">{{ journalist.language|upper }} - {{ journalist.tone }}</p>
        </div>
    </div>
    {% endif %}
    
    <form action="{{ url_for('journalists.edit', id=journalist.id) if journalist else url_for('journalists.create') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">{% if current_lang == 'fr' %}Informations générales{% else %}General Information{% endif %}</h3>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('journalist_name') }} *</label>
                    <input type="text" name="name" required value="{{ journalist.name if journalist else '' }}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent" 
                           placeholder="{% if current_lang == 'fr' %}Ex: TechBot, NewsAI...{% else %}e.g., TechBot, NewsAI...{% endif %}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('telegram_bot_token') }} *</label>
                    <input type="text" name="telegram_token" required value="{{ journalist.telegram_token if journalist else '' }}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent" 
                           placeholder="123456:ABC-DEF...">
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Photo du bot{% else %}Bot Photo{% endif %}</label>
                    <div class="flex flex-col gap-3">
                        <div id="photoPreview">
                            {% if journalist and journalist.photo_url %}
                            <div class="w-24 h-24 rounded-lg overflow-hidden border-2 border-gray-200">
                                <img id="photoImg" src="{{ journalist.photo_url }}" alt="{{ journalist.name }}" class="w-full h-full object-cover">
                            </div>
                            {% endif %}
                        </div>
                        <input type="hidden" id="photoUrlField" name="photo_url" value="{{ journalist.photo_url if journalist else '' }}">
                        <input type="file" name="photo" accept="image/*" 
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 cursor-pointer" 
                               placeholder="{% if current_lang == 'fr' %}Télécharger une photo...{% else %}Upload a photo...{% endif %}">
                        <button type="button" onclick="fetchBotPhoto()" 
                                class="w-full px-4 py-2 bg-blue-50 text-blue-600 border border-blue-200 rounded-xl hover:bg-blue-100 transition text-sm font-medium">
                            <i class="fas fa-download mr-2"></i>{% if current_lang == 'fr' %}Récupérer la photo du bot{% else %}Fetch Bot Photo{% endif %}
                        </button>
                        <small class="text-gray-500">{% if current_lang == 'fr' %}Formats acceptés: PNG, JPG, GIF. Taille max: 10MB{% else %}Supported: PNG, JPG, GIF. Max: 10MB{% endif %}</small>
                        <div id="photoStatus" class="hidden p-2 rounded-lg text-sm"></div>
                    </div>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('language') }}</label>
                    <select name="language" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                        <option value="fr" {% if journalist and journalist.language == 'fr' %}selected{% endif %}>{{ _('french') }}</option>
                        <option value="en" {% if journalist and journalist.language == 'en' %}selected{% endif %}>{{ _('english') }}</option>
                        <option value="es" {% if journalist and journalist.language == 'es' %}selected{% endif %}>Español</option>
                        <option value="de" {% if journalist and journalist.language == 'de' %}selected{% endif %}>Deutsch</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{{ _('journalist_timezone') }}</label>
                    <select name="timezone" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                        {% for tz_value, tz_label in timezones %}
                            <option value="{{ tz_value }}" {% if (not journalist and tz_value == 'Europe/Paris') or (journalist and journalist.timezone == tz_value) %}selected{% endif %}>{{ tz_label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Heure de récupération{% else %}Fetch Time{% endif %}</label>
                    <input type="time" name="fetch_time" value="{{ journalist.fetch_time if journalist else '02:00' }}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                    <small class="text-gray-500">{% if current_lang == 'fr' %}Récupération articles{% else %}Article fetch{% endif %}</small>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Heure du résumé{% else %}Summary Time{% endif %}</label>
                    <input type="time" name="summary_time" value="{{ journalist.summary_time if journalist else '08:00' }}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                    <small class="text-gray-500">{% if current_lang == 'fr' %}Génération résumé{% else %}Summary generation{% endif %}</small>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Heure d'envoi{% else %}Send Time{% endif %}</label>
                    <input type="time" name="send_time" value="{{ journalist.send_time if journalist else '08:00' }}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                    <small class="text-gray-500">{% if current_lang == 'fr' %}Envoi à abonnés{% else %}Send to subscribers{% endif %}</small>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">{% if current_lang == 'fr' %}Personnalité et style{% else %}Personality and Style{% endif %}</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Personnalité{% else %}Personality{% endif %}</label>
                    <textarea name="personality" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" 
                              placeholder="{% if current_lang == 'fr' %}Décrivez la personnalité du journaliste...{% else %}Describe the journalist's personality...{% endif %}">{{ journalist.personality if journalist else ('Journaliste professionnel et objectif' if current_lang == 'fr' else 'Professional and objective journalist') }}</textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Style d'écriture{% else %}Writing Style{% endif %}</label>
                    <textarea name="writing_style" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" 
                              placeholder="{% if current_lang == 'fr' %}Décrivez le style d'écriture...{% else %}Describe the writing style...{% endif %}">{{ journalist.writing_style if journalist else ('Clair, engageant et accessible' if current_lang == 'fr' else 'Clear, engaging and accessible') }}</textarea>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Style orthographique{% else %}Spelling Style{% endif %}</label>
                        <select name="spelling_style" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                            <option value="standard" {% if journalist and journalist.spelling_style == 'standard' %}selected{% endif %}>Standard</option>
                            <option value="formal" {% if journalist and journalist.spelling_style == 'formal' %}selected{% endif %}>{% if current_lang == 'fr' %}Formel{% else %}Formal{% endif %}</option>
                            <option value="casual" {% if journalist and journalist.spelling_style == 'casual' %}selected{% endif %}>{% if current_lang == 'fr' %}Décontracté{% else %}Casual{% endif %}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Ton{% else %}Tone{% endif %}</label>
                        <select name="tone" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                            <option value="neutral" {% if journalist and journalist.tone == 'neutral' %}selected{% endif %}>{% if current_lang == 'fr' %}Neutre{% else %}Neutral{% endif %}</option>
                            <option value="friendly" {% if journalist and journalist.tone == 'friendly' %}selected{% endif %}>{% if current_lang == 'fr' %}Amical{% else %}Friendly{% endif %}</option>
                            <option value="professional" {% if journalist and journalist.tone == 'professional' %}selected{% endif %}>{% if current_lang == 'fr' %}Professionnel{% else %}Professional{% endif %}</option>
                            <option value="enthusiastic" {% if journalist and journalist.tone == 'enthusiastic' %}selected{% endif %}>{% if current_lang == 'fr' %}Enthousiaste{% else %}Enthusiastic{% endif %}</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">{% if current_lang == 'fr' %}Fournisseur IA{% else %}AI Provider{% endif %}</h3>
            
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Provider IA{% else %}AI Provider{% endif %}</label>
                    <select name="ai_provider" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" onchange="updateModelOptions()">
                        <option value="gemini" {% if journalist and journalist.ai_provider == 'gemini' %}selected{% endif %}>Google Gemini</option>
                        <option value="perplexity" {% if journalist and journalist.ai_provider == 'perplexity' %}selected{% endif %}>Perplexity</option>
                        <option value="openai" {% if journalist and journalist.ai_provider == 'openai' %}selected{% endif %}>OpenAI</option>
                        <option value="openrouter" {% if journalist and journalist.ai_provider == 'openrouter' %}selected{% endif %}>OpenRouter</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}Modèle{% else %}Model{% endif %}</label>
                    <input type="text" id="ai_model" name="ai_model" value="{{ journalist.ai_model if journalist else 'auto' }}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" 
                           placeholder="auto">
                </div>
            </div>
            
            <button type="button" onclick="testModel()" class="mt-4 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition text-sm">
                <i class="fas fa-test mr-2"></i>{% if current_lang == 'fr' %}Tester le modèle{% else %}Test Model{% endif %}
            </button>
            <div id="test-result" class="mt-3 p-3 rounded-lg hidden"></div>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">Audio (Eleven Labs)</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="flex items-center gap-3 p-3 bg-purple-50 border border-purple-200 rounded-xl cursor-pointer hover:bg-purple-100 transition">
                        <input type="checkbox" name="enable_eleven_labs" {% if journalist and journalist.enable_eleven_labs %}checked{% endif %} 
                               class="w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                        <div>
                            <span class="font-medium text-gray-800">{% if current_lang == 'fr' %}Activer la génération audio Eleven Labs{% else %}Enable Eleven Labs Audio Generation{% endif %}</span>
                            <p class="text-xs text-gray-600 mt-1">{% if current_lang == 'fr' %}Génère des résumés en audio avec voix naturelle{% else %}Generate audio summaries with natural voices{% endif %}</p>
                        </div>
                    </label>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">{% if current_lang == 'fr' %}ID de voix Eleven Labs{% else %}Eleven Labs Voice ID{% endif %}</label>
                    <input type="text" name="eleven_labs_voice_id" value="{{ journalist.eleven_labs_voice_id if journalist else '' }}" 
                           class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" 
                           placeholder="{% if current_lang == 'fr' %}Ex: 21m00Tcm4TlvDq8ikWAM{% else %}e.g., 21m00Tcm4TlvDq8ikWAM{% endif %}">
                    <small class="text-gray-500">{% if current_lang == 'fr' %}Trouvez les IDs des voix sur eleven-labs.io{% else %}Find voice IDs at eleven-labs.io{% endif %}</small>
                </div>
            </div>
        </div>
        
        {% if journalist %}
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h3 class="font-semibold text-gray-800 mb-4">{{ _('status') }}</h3>
            <label class="flex items-center gap-3">
                <input type="checkbox" name="is_active" {% if journalist.is_active %}checked{% endif %} 
                       class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                <span class="text-gray-700">{% if current_lang == 'fr' %}Journaliste actif{% else %}Active journalist{% endif %}</span>
            </label>
        </div>
        {% endif %}
        
        <div class="flex gap-4">
            <button type="submit" class="flex-1 py-3 bg-primary-600 text-white rounded-xl hover:bg-primary-700 transition font-medium">
                <i class="fas fa-save mr-2"></i>
                {% if journalist %}{{ _('save') }}{% else %}{{ _('create_journalist') }}{% endif %}
            </button>
            
            {% if journalist %}
            <button type="button" onclick="confirmDelete()" class="px-6 py-3 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </form>
</div>

{% if journalist %}
<form id="deleteForm" action="{{ url_for('journalists.delete', id=journalist.id) }}" method="POST" class="hidden"></form>
{% endif %}

<script>
async function fetchBotPhoto() {
    const token = document.querySelector('input[name="telegram_token"]').value;
    const statusDiv = document.getElementById('photoStatus');
    
    if (!token) {
        statusDiv.textContent = '{% if current_lang == "fr" %}Entrez d\'abord un token Telegram{% else %}Enter a Telegram token first{% endif %}';
        statusDiv.className = 'block p-2 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-700';
        return;
    }
    
    statusDiv.textContent = '{% if current_lang == "fr" %}Récupération...{% else %}Fetching...{% endif %}';
    statusDiv.className = 'block p-2 rounded-lg text-sm bg-blue-50 border border-blue-200 text-blue-700';
    
    try {
        const response = await fetch('/api/journalist/fetch-bot-photo', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({telegram_token: token})
        });
        
        const data = await response.json();
        
        if (data.success && data.photo_url) {
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = `<div class="w-24 h-24 rounded-lg overflow-hidden border-2 border-gray-200">
                <img id="photoImg" src="${data.photo_url}" alt="Bot photo" class="w-full h-full object-cover">
            </div>`;
            // IMPORTANT: Save the photo URL to the hidden field so it gets submitted with the form
            document.getElementById('photoUrlField').value = data.photo_url;
            statusDiv.textContent = '✓ {% if current_lang == "fr" %}Photo récupérée avec succès!{% else %}Photo fetched successfully!{% endif %}';
            statusDiv.className = 'block p-2 rounded-lg text-sm bg-green-50 border border-green-200 text-green-700';
        } else {
            statusDiv.textContent = '✗ ' + (data.error || '{% if current_lang == "fr" %}Impossible de récupérer la photo{% else %}Could not fetch photo{% endif %}');
            statusDiv.className = 'block p-2 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
        }
    } catch (error) {
        statusDiv.textContent = '✗ {% if current_lang == "fr" %}Erreur réseau{% else %}Network error{% endif %}: ' + error.message;
        statusDiv.className = 'block p-2 rounded-lg text-sm bg-red-50 border border-red-200 text-red-700';
    }
}

function confirmDelete() {
    if (confirm('{{ _("confirm_delete") }}')) {
        document.getElementById('deleteForm').submit();
    }
}

function updateModelOptions() {
    const provider = document.querySelector('select[name="ai_provider"]').value;
    const modelInput = document.getElementById('ai_model');
    
    const defaults = {
        'gemini': 'gemini-2.0-flash',
        'perplexity': 'auto',
        'openai': 'gpt-4o-mini',
        'openrouter': 'openrouter/auto'
    };
    
    if (modelInput.value === 'auto' || modelInput.value === '') {
        modelInput.placeholder = defaults[provider];
    }
}

async function testModel() {
    const provider = document.querySelector('select[name="ai_provider"]').value;
    const model = document.getElementById('ai_model').value || 'auto';
    const resultDiv = document.getElementById('test-result');
    
    resultDiv.innerHTML = '<div class="text-gray-600">{% if current_lang == "fr" %}Test en cours...{% else %}Testing...{% endif %}</div>';
    resultDiv.classList.remove('hidden');
    
    try {
        const response = await fetch('/api/ai/test-model', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({provider, model})
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `<div class="bg-green-50 border border-green-200 text-green-700 rounded">
                <strong>✓ {% if current_lang == "fr" %}Succès!{% else %}Success!{% endif %}</strong><br>
                <small>${data.response}</small>
            </div>`;
        } else {
            resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 rounded">
                <strong>✗ {% if current_lang == "fr" %}Erreur{% else %}Error{% endif %}</strong><br>
                <small>${data.error}</small>
            </div>`;
        }
    } catch (e) {
        resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 rounded">
            <strong>✗ {% if current_lang == "fr" %}Erreur réseau{% else %}Network Error{% endif %}</strong><br>
            <small>${e.message}</small>
        </div>`;
    }
}
</script>
{% endblock %}
