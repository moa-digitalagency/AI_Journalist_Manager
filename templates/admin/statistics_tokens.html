{% extends "admin/base.html" %}

{% block title %}{{ _('statistics') }}{% endblock %}
{% block header %}{{ _('statistics') }}{% endblock %}
{% block subheader %}{{ _('overview') }} - {{ _('journalists') }}, {{ _('subscribers') }}, {{ _('tokens') }} & {{ _('cost') }}{% endblock %}

{% block content %}
<!-- Global Statistics -->
<div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">{{ _('global_stats') }}</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Bots -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ _('total_bots') }}</p>
                    <p class="text-3xl font-bold text-gray-800 mt-1">{{ global_stats.total_journalists }}</p>
                    <p class="text-xs text-green-600 mt-2"><i class="fas fa-check-circle mr-1"></i>{{ global_stats.active_bots }} {{ _('active') | lower }}</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-primary-100 flex items-center justify-center">
                    <i class="fas fa-robot text-2xl text-primary-600"></i>
                </div>
            </div>
        </div>
        
        <!-- Subscribers -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ _('total_subscribers') }}</p>
                    <p class="text-3xl font-bold text-gray-800 mt-1">{{ global_stats.total_subscribers }}</p>
                    <p class="text-xs text-green-600 mt-2"><i class="fas fa-check-circle mr-1"></i>{{ global_stats.approved_subscribers }} {{ _('approved') | lower }}</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-green-100 flex items-center justify-center">
                    <i class="fas fa-users text-2xl text-green-600"></i>
                </div>
            </div>
        </div>
        
        <!-- Text Summaries -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ _('text_summaries') }}</p>
                    <p class="text-3xl font-bold text-gray-800 mt-1">{{ global_stats.text_summaries }}</p>
                    <p class="text-xs text-blue-600 mt-2"><i class="fas fa-file-alt mr-1"></i>{{ global_stats.total_summaries }} {{ _('total') | lower }}</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-file-lines text-2xl text-blue-600"></i>
                </div>
            </div>
        </div>
        
        <!-- Audio Summaries -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">{{ _('audio_summaries') }}</p>
                    <p class="text-3xl font-bold text-gray-800 mt-1">{{ global_stats.audio_summaries }}</p>
                    <p class="text-xs text-purple-600 mt-2"><i class="fas fa-volume-up mr-1"></i>{{ global_stats.total_sent }} {{ _('sent') | lower }}</p>
                </div>
                <div class="w-14 h-14 rounded-2xl bg-purple-100 flex items-center justify-center">
                    <i class="fas fa-headphones text-2xl text-purple-600"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Journalist Stats with Detailed Token Costs by Model -->
<div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">ü§ñ {{ _('journalists') }} - {{ _('tokens') }} & {{ _('cost') }}</h2>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left font-semibold text-gray-700">{{ _('name') }}</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-700">{{ _('ai_provider') }}</th>
                        <th class="px-6 py-3 text-center font-semibold text-gray-700">üë• {{ _('subscribers') }}</th>
                        <th class="px-6 py-3 text-center font-semibold text-gray-700">üìù {{ _('summaries') }}</th>
                        <th class="px-6 py-3 text-center font-semibold text-gray-700">üéôÔ∏è {{ _('audio') }}</th>
                        <th class="px-6 py-3 text-center font-semibold text-gray-700">üî¢ {{ _('tokens') }}</th>
                        <th class="px-6 py-3 text-center font-semibold text-gray-700">üí∞ {{ _('cost') }}</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-700">{{ _('cost_breakdown') }}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for stat in journalist_stats %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 font-medium text-gray-800">{{ stat.name }}</td>
                        <td class="px-6 py-4 text-gray-700">{{ stat.ai_provider }}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                {{ stat.subscribers }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                {{ stat.summaries }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
                                {{ stat.audio_summaries }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                                {{ "{:,.0f}".format(stat.total_tokens) }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center font-semibold text-red-600">
                            ${{ "%.4f" | format(stat.total_cost) }}
                        </td>
                        <td class="px-6 py-4 text-xs">
                            {% if stat.provider_model_costs %}
                                <div class="space-y-2">
                                    {% for provider, models in stat.provider_model_costs.items() %}
                                        <div class="border-l-2 border-gray-300 pl-2">
                                            <div class="font-semibold text-gray-700 mb-1">{{ provider | upper }}</div>
                                            {% for model, costs in models.items() %}
                                                <div class="text-gray-600 text-xs mb-1">
                                                    <div class="font-medium">{{ model }}</div>
                                                    {% if costs.text_tokens > 0 %}
                                                        <div class="ml-2">üìÑ {{ _('text') }}: {{ "{:,.0f}".format(costs.text_tokens) }} tk = ${{ "%.4f" | format(costs.text_cost) }}</div>
                                                    {% endif %}
                                                    {% if costs.audio_tokens > 0 %}
                                                        <div class="ml-2">üîä {{ _('audio') }}: {{ "{:,.0f}".format(costs.audio_tokens) }} tk = ${{ "%.4f" | format(costs.audio_cost) }}</div>
                                                    {% endif %}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-gray-400">{{ _('no_usage') }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">{{ _('no_data') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Top Subscribers -->
<div class="mb-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">{{ _('top_subscribers') }}</h2>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left font-semibold text-gray-700">{{ _('username') }}</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-700">{{ _('bot') }}</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-700">{{ _('plan') }}</th>
                        <th class="px-6 py-3 text-center font-semibold text-gray-700">üí¨ {{ _('messages') }}</th>
                        <th class="px-6 py-3 text-center font-semibold text-gray-700">{{ _('approved') | capitalize }}</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-700">{{ _('joined') | capitalize }}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for stat in subscriber_stats %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 font-medium text-gray-800">{{ stat.username }}</td>
                        <td class="px-6 py-4 text-gray-700">{{ stat.journalist }}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-cyan-100 text-cyan-800">
                                {{ stat.plan }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-pink-100 text-pink-800">
                                {{ stat.messages }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if stat.approved %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>{{ _('yes') }}
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-clock mr-1"></i>{{ _('pending') }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-gray-700">{{ format_datetime(stat.joined, 'short') }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">{{ _('no_data') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
