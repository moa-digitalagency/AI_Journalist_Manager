{% extends "admin/base.html" %}

{% block title %}{{ _('settings') }}{% endblock %}
{% block header %}{{ _('settings') }}{% endblock %}
{% block subheader %}{% if current_lang == 'fr' %}Configurez les options g√©n√©rales et les APIs{% else %}Configure general options and APIs{% endif %}{% endblock %}

{% block content %}
<div class="space-y-6">
    
    <!-- Quick Navigation Tabs -->
    <div class="flex gap-2 overflow-x-auto pb-2 sticky top-0 bg-white z-10 rounded-xl">
        <button onclick="switchTab('api-status')" class="tab-btn px-6 py-3 rounded-lg font-medium text-sm whitespace-nowrap transition-all" data-tab="api-status">
            <i class="fas fa-plug mr-2"></i>{% if current_lang == 'fr' %}APIs{% else %}APIs{% endif %}
        </button>
        <button onclick="switchTab('general')" class="tab-btn px-6 py-3 rounded-lg font-medium text-sm whitespace-nowrap transition-all" data-tab="general">
            <i class="fas fa-sliders-h mr-2"></i>{% if current_lang == 'fr' %}G√©n√©ral{% else %}General{% endif %}
        </button>
        <button onclick="switchTab('api')" class="tab-btn px-6 py-3 rounded-lg font-medium text-sm whitespace-nowrap transition-all" data-tab="api">
            <i class="fas fa-brain mr-2"></i>{% if current_lang == 'fr' %}Mod√®les IA{% else %}AI Models{% endif %}
        </button>
        <button onclick="switchTab('notifications')" class="tab-btn px-6 py-3 rounded-lg font-medium text-sm whitespace-nowrap transition-all" data-tab="notifications">
            <i class="fas fa-bell mr-2"></i>{% if current_lang == 'fr' %}Notifications{% else %}Notifications{% endif %}
        </button>
        <button onclick="switchTab('security')" class="tab-btn px-6 py-3 rounded-lg font-medium text-sm whitespace-nowrap transition-all" data-tab="security">
            <i class="fas fa-shield-alt mr-2"></i>{% if current_lang == 'fr' %}S√©curit√©{% else %}Security{% endif %}
        </button>
        <button onclick="switchTab('seo')" class="tab-btn px-6 py-3 rounded-lg font-medium text-sm whitespace-nowrap transition-all" data-tab="seo">
            <i class="fas fa-search mr-2"></i>SEO
        </button>
    </div>

    <!-- API Status Section -->
    <div id="api-status" class="tab-content">
        <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl p-8 shadow-sm border border-blue-100">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900 mb-2 flex items-center gap-3">
                        <span class="p-3 bg-blue-600 text-white rounded-lg"><i class="fas fa-plug"></i></span>
                        {% if current_lang == 'fr' %}Statut des APIs{% else %}External API Status{% endif %}
                    </h2>
                    <p class="text-slate-600">{% if current_lang == 'fr' %}Les cl√©s API doivent √™tre configur√©es dans les variables d'environnement{% else %}API keys must be configured in environment variables{% endif %}</p>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                {% for key, api in api_status.items() %}
                <div class="group relative bg-white rounded-xl p-6 border-2 transition-all hover:shadow-lg {% if api.configured %}border-green-200 bg-white{% else %}border-{% if api.required %}red{% else %}amber{% endif %}-200{% endif %}">
                    <div class="absolute top-4 right-4">
                        {% if api.configured %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                            <i class="fas fa-check-circle"></i>{% if current_lang == 'fr' %}Actif{% else %}Active{% endif %}
                        </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-{% if api.required %}red{% else %}amber{% endif %}-100 text-{% if api.required %}red{% else %}amber{% endif %}-700">
                            <i class="fas fa-alert-circle"></i>{% if api.required %}{% if current_lang == 'fr' %}Requis{% else %}Required{% endif %}{% else %}{% if current_lang == 'fr' %}Optionnel{% else %}Optional{% endif %}{% endif %}
                        </span>
                        {% endif %}
                    </div>
                    <h4 class="font-bold text-slate-900 mb-2 pr-24">{{ api.name }}</h4>
                    <p class="text-sm text-slate-600 mb-4 line-clamp-2">{{ api.description }}</p>
                    {% if api.configured and key in ['gemini', 'eleven_labs', 'perplexity', 'openai', 'openrouter'] %}
                    <button onclick="testApi('{{ key }}')" class="mt-2 w-full px-3 py-2 bg-blue-50 text-blue-700 rounded-lg text-xs font-medium hover:bg-blue-100 transition-colors">
                        <i class="fas fa-vial mr-1"></i>{% if current_lang == 'fr' %}Tester{% else %}Test{% endif %}
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
                <!-- 7√®me bloc optionnel -->
                <div class="group relative bg-white rounded-xl p-6 border-2 transition-all hover:shadow-lg border-amber-200">
                    <div class="absolute top-4 right-4">
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">
                            <i class="fas fa-alert-circle"></i>{% if current_lang == 'fr' %}Optionnel{% else %}Optional{% endif %}
                        </span>
                    </div>
                    <h4 class="font-bold text-slate-900 mb-2 pr-24">{% if current_lang == 'fr' %}Service personnalis√©{% else %}Custom Service{% endif %}</h4>
                    <p class="text-sm text-slate-600 mb-4 line-clamp-2">{% if current_lang == 'fr' %}Espace r√©serv√© pour services additionnels{% else %}Reserved for additional services{% endif %}</p>
                </div>
            </div>

            <div id="testResult" class="hidden mb-6 p-6 bg-white rounded-xl border-2 border-blue-200">
                <div class="flex items-start gap-4">
                    <div id="testIcon" class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0"></div>
                    <div class="flex-1">
                        <p id="testMessage" class="font-semibold text-slate-900 mb-1"></p>
                        <p id="testDetails" class="text-sm text-slate-600"></p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
                <h3 class="font-bold text-blue-900 mb-4"><i class="fas fa-lightbulb mr-2"></i>{% if current_lang == 'fr' %}Comment configurer les APIs{% else %}How to configure APIs{% endif %}</h3>
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div class="space-y-2">
                        <p><strong>GEMINI_API_KEY:</strong> <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a></p>
                        <p><strong>PERPLEXITY_API_KEY:</strong> <a href="https://www.perplexity.ai/api" target="_blank" class="text-blue-600 hover:underline">Perplexity API</a></p>
                    </div>
                    <div class="space-y-2">
                        <p><strong>OPENAI_API_KEY:</strong> <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 hover:underline">OpenAI Platform</a></p>
                        <p><strong>ELEVEN_LABS_API_KEY:</strong> <a href="https://elevenlabs.io/api" target="_blank" class="text-blue-600 hover:underline">Eleven Labs</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form action="{{ url_for('settings.update') }}" method="POST" class="space-y-6">
        
        <!-- General Settings -->
        <div id="general" class="tab-content">
            <div class="bg-gradient-to-br from-slate-50 to-amber-50 rounded-2xl p-8 shadow-sm border border-amber-100">
                <div class="flex items-center gap-3 mb-8">
                    <span class="p-3 bg-amber-600 text-white rounded-lg"><i class="fas fa-sliders-h"></i></span>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">{{ _('general_settings') }}</h2>
                        <p class="text-sm text-slate-600">{% if current_lang == 'fr' %}Param√®tres de base{% else %}Basic configuration{% endif %}</p>
                    </div>
                </div>
                
                {% if settings.general %}
                <div class="grid md:grid-cols-2 gap-6">
                    {% for setting in settings.general %}
                    <div class="group">
                        <label class="block text-sm font-semibold text-slate-700 mb-3">
                            {% if setting.description %}{{ setting.description }}{% else %}{{ setting.key }}{% endif %}
                        </label>
                        {% if setting.key == 'default_language' %}
                        <select name="setting_{{ setting.key }}" class="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 bg-white font-medium transition-all">
                            <option value="fr" {% if setting.value == 'fr' %}selected{% endif %}>üá´üá∑ Fran√ßais</option>
                            <option value="en" {% if setting.value == 'en' %}selected{% endif %}>üá¨üáß English</option>
                            <option value="es" {% if setting.value == 'es' %}selected{% endif %}>üá™üá∏ Espa√±ol</option>
                            <option value="de" {% if setting.value == 'de' %}selected{% endif %}>üá©üá™ Deutsch</option>
                        </select>
                        {% elif setting.key == 'default_timezone' %}
                        <select name="setting_{{ setting.key }}" class="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 bg-white font-medium transition-all">
                            <option value="">{% if current_lang == 'fr' %}S√©lectionner un fuseau horaire{% else %}Select a timezone{% endif %}</option>
                            <option value="UTC" {% if setting.value == 'UTC' %}selected{% endif %}>UTC</option>
                            <option value="Africa/Lagos" {% if setting.value == 'Africa/Lagos' %}selected{% endif %}>Africa/Lagos</option>
                            <option value="America/New_York" {% if setting.value == 'America/New_York' %}selected{% endif %}>America/New_York</option>
                            <option value="America/Los_Angeles" {% if setting.value == 'America/Los_Angeles' %}selected{% endif %}>America/Los_Angeles</option>
                            <option value="Asia/Tokyo" {% if setting.value == 'Asia/Tokyo' %}selected{% endif %}>Asia/Tokyo</option>
                            <option value="Asia/Bangkok" {% if setting.value == 'Asia/Bangkok' %}selected{% endif %}>Asia/Bangkok</option>
                            <option value="Europe/Paris" {% if setting.value == 'Europe/Paris' %}selected{% endif %}>Europe/Paris</option>
                            <option value="Europe/London" {% if setting.value == 'Europe/London' %}selected{% endif %}>Europe/London</option>
                            <option value="Europe/Berlin" {% if setting.value == 'Europe/Berlin' %}selected{% endif %}>Europe/Berlin</option>
                            <option value="Australia/Sydney" {% if setting.value == 'Australia/Sydney' %}selected{% endif %}>Australia/Sydney</option>
                        </select>
                        {% elif setting.key in ['fetch_hour', 'summary_hour'] %}
                        <div class="flex gap-2 items-center">
                            <input type="number" id="{{ setting.key }}_hours" min="0" max="23" value="{{ setting.value.split(':')[0] if ':' in setting.value else setting.value }}" 
                                   class="w-20 px-3 py-3 border-2 border-amber-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 font-medium transition-all text-center" placeholder="HH">
                            <span class="text-slate-600 font-semibold">:</span>
                            <input type="number" id="{{ setting.key }}_minutes" min="0" max="59" value="{{ setting.value.split(':')[1] if ':' in setting.value else '0' }}" 
                                   class="w-20 px-3 py-3 border-2 border-amber-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 font-medium transition-all text-center" placeholder="MM">
                            <span class="text-slate-600 font-semibold">:</span>
                            <input type="number" id="{{ setting.key }}_seconds" min="0" max="59" value="{{ setting.value.split(':')[2] if ':' in setting.value else '0' }}" 
                                   class="w-20 px-3 py-3 border-2 border-amber-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 font-medium transition-all text-center" placeholder="SS">
                            <input type="hidden" name="setting_{{ setting.key }}" id="hidden_{{ setting.key }}" value="{{ setting.value }}">
                            <script>
                                document.getElementById('{{ setting.key }}_hours').addEventListener('change', function() {
                                    updateTimeValue('{{ setting.key }}');
                                });
                                document.getElementById('{{ setting.key }}_minutes').addEventListener('change', function() {
                                    updateTimeValue('{{ setting.key }}');
                                });
                                document.getElementById('{{ setting.key }}_seconds').addEventListener('change', function() {
                                    updateTimeValue('{{ setting.key }}');
                                });
                            </script>
                        </div>
                        {% elif setting.key in ['trial_days', 'max_login_attempts', 'session_timeout'] %}
                        <input type="number" name="setting_{{ setting.key }}" value="{{ setting.value }}" 
                               class="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 font-medium transition-all">
                        {% else %}
                        <input type="text" name="setting_{{ setting.key }}" value="{{ setting.value }}" 
                               class="w-full px-4 py-3 border-2 border-amber-200 rounded-lg focus:border-amber-500 focus:ring-2 focus:ring-amber-200 font-medium transition-all">
                        {% endif %}
                        <input type="hidden" name="category_{{ setting.key }}" value="general">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-slate-500 text-center py-8">{% if current_lang == 'fr' %}Aucun param√®tre g√©n√©ral.{% else %}No general settings.{% endif %}</p>
                {% endif %}
            </div>
        </div>

        <!-- API Configuration -->
        <div id="api" class="tab-content">
            <div class="bg-gradient-to-br from-slate-50 to-purple-50 rounded-2xl p-8 shadow-sm border border-purple-100">
                <div class="flex items-center gap-3 mb-8">
                    <span class="p-3 bg-purple-600 text-white rounded-lg"><i class="fas fa-brain"></i></span>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">{% if current_lang == 'fr' %}Configuration Mod√®les IA{% else %}AI Model Configuration{% endif %}</h2>
                        <p class="text-sm text-slate-600">{% if current_lang == 'fr' %}S√©lectionnez vos mod√®les IA pr√©f√©r√©s (les mod√®les suppl√©mentaires apparaissent selon votre s√©lection){% else %}Select your preferred AI models (additional models appear based on your selection){% endif %}</p>
                    </div>
                </div>

                {% set default_ai_setting = settings.api|selectattr('key', 'equalto', 'default_ai_model')|first %}
                {% if default_ai_setting %}
                <div class="bg-white rounded-xl p-6 border-2 border-purple-200 mb-8">
                    <label class="block text-sm font-semibold text-slate-700 mb-4">
                        <i class="fas fa-star text-purple-600 mr-2"></i>{% if current_lang == 'fr' %}Mod√®le IA par d√©faut{% else %}Default AI Model{% endif %}
                    </label>
                    <div class="space-y-4">
                        <select id="default_ai_model_select" name="setting_{{ default_ai_setting.key }}" class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 bg-white font-medium transition-all" onchange="updateDynamicModels()">
                            <option value="perplexity" {% if default_ai_setting.value == 'perplexity' %}selected{% endif %}>üîç Perplexity AI</option>
                            <option value="gemini" {% if default_ai_setting.value == 'gemini' %}selected{% endif %}>‚ú® Google Gemini</option>
                            <option value="openai" {% if default_ai_setting.value == 'openai' %}selected{% endif %}>ü§ñ OpenAI</option>
                            <option value="openrouter" {% if default_ai_setting.value == 'openrouter' %}selected{% endif %}>üöÄ OpenRouter</option>
                        </select>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="testApi('perplexity')" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition font-medium text-sm">
                                <i class="fas fa-flask mr-1"></i>{% if current_lang == 'fr' %}Tester PPX{% else %}Test PPX{% endif %}
                            </button>
                            <button type="button" onclick="testApi('gemini')" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition font-medium text-sm">
                                <i class="fas fa-flask mr-1"></i>{% if current_lang == 'fr' %}Tester GEM{% else %}Test GEM{% endif %}
                            </button>
                            <button type="button" onclick="testApi('openai')" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition font-medium text-sm">
                                <i class="fas fa-flask mr-1"></i>{% if current_lang == 'fr' %}Tester OAI{% else %}Test OAI{% endif %}
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="category_{{ default_ai_setting.key }}" value="api">
                </div>
                {% endif %}

                <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i class="fas fa-cog text-purple-600"></i>{% if current_lang == 'fr' %}Param√®tres des Mod√®les{% else %}Model Configuration{% endif %}
                </h3>
                
                <div class="grid md:grid-cols-2 gap-6">
                    {% for setting in settings.api %}
                        {% if setting.key != 'default_ai_model' %}
                        <div class="bg-white rounded-xl p-6 border-2 border-purple-100 hover:border-purple-300 transition-colors model-setting" data-model="{{ 'gemini' if setting.key == 'gemini_model' else 'perplexity' if setting.key == 'perplexity_model' else 'openai' if setting.key == 'openai_model' else 'openrouter' if setting.key == 'openrouter_model' else 'all' }}">
                            <label class="block text-sm font-semibold text-slate-700 mb-3">
                                {% if setting.description %}{{ setting.description }}{% else %}{{ setting.key }}{% endif %}
                            </label>
                            {% if setting.key == 'youtube_transcript_languages' %}
                            <div class="grid grid-cols-2 gap-3">
                                <div class="flex items-center">
                                    <input type="checkbox" id="lang_fr" name="setting_{{ setting.key }}_fr" value="fr" {% if 'fr' in setting.value %}checked{% endif %} class="w-4 h-4 rounded border-gray-300 mr-2">
                                    <label for="lang_fr" class="text-sm text-slate-600">üá´üá∑ Fran√ßais</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="lang_en" name="setting_{{ setting.key }}_en" value="en" {% if 'en' in setting.value %}checked{% endif %} class="w-4 h-4 rounded border-gray-300 mr-2">
                                    <label for="lang_en" class="text-sm text-slate-600">üá¨üáß English</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="lang_es" name="setting_{{ setting.key }}_es" value="es" {% if 'es' in setting.value %}checked{% endif %} class="w-4 h-4 rounded border-gray-300 mr-2">
                                    <label for="lang_es" class="text-sm text-slate-600">üá™üá∏ Espa√±ol</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="lang_de" name="setting_{{ setting.key }}_de" value="de" {% if 'de' in setting.value %}checked{% endif %} class="w-4 h-4 rounded border-gray-300 mr-2">
                                    <label for="lang_de" class="text-sm text-slate-600">üá©üá™ Deutsch</label>
                                </div>
                            </div>
                            <input type="hidden" id="hidden_{{ setting.key }}" name="setting_{{ setting.key }}" value="{{ setting.value }}">
                            <script>
                                document.querySelectorAll('input[name^="setting_youtube_transcript_languages_"]').forEach(el => {
                                    el.addEventListener('change', function() {
                                        const langs = Array.from(document.querySelectorAll('input[name^="setting_youtube_transcript_languages_"]:checked'))
                                            .map(e => e.value).join(',');
                                        document.getElementById('hidden_youtube_transcript_languages').value = langs;
                                    });
                                });
                            </script>
                            {% else %}
                            <input type="text" name="setting_{{ setting.key }}" value="{{ setting.value }}" 
                                   class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 font-medium transition-all">
                            {% endif %}
                            <input type="hidden" name="category_{{ setting.key }}" value="api">
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notifications" class="tab-content">
            <div class="bg-gradient-to-br from-slate-50 to-pink-50 rounded-2xl p-8 shadow-sm border border-pink-100">
                <div class="flex items-center gap-3 mb-8">
                    <span class="p-3 bg-pink-600 text-white rounded-lg"><i class="fas fa-bell"></i></span>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">{% if current_lang == 'fr' %}Notifications{% else %}Notifications{% endif %}</h2>
                        <p class="text-sm text-slate-600">{% if current_lang == 'fr' %}G√©rez vos pr√©f√©rences de notification{% else %}Manage notification preferences{% endif %}</p>
                    </div>
                </div>

                {% if settings.notifications %}
                <div class="space-y-4">
                    {% for setting in settings.notifications %}
                    <div class="bg-white rounded-xl p-6 border-2 border-pink-100 hover:border-pink-300 transition-colors">
                        {% if setting.value in ['true', 'false'] %}
                        <div class="flex items-center justify-between">
                            <label for="notif_{{ setting.key }}" class="text-sm font-semibold text-slate-700 cursor-pointer">
                                {% if setting.description %}{{ setting.description }}{% else %}{{ setting.key }}{% endif %}
                            </label>
                            <input type="checkbox" id="notif_{{ setting.key }}" name="setting_{{ setting.key }}" value="true" {% if setting.value == 'true' %}checked{% endif %} class="w-5 h-5 rounded cursor-pointer">
                            <input type="hidden" name="setting_{{ setting.key }}" value="false">
                        </div>
                        {% else %}
                        <label class="block text-sm font-semibold text-slate-700 mb-3">
                            {% if setting.description %}{{ setting.description }}{% else %}{{ setting.key }}{% endif %}
                        </label>
                        <input type="text" name="setting_{{ setting.key }}" value="{{ setting.value }}" 
                               class="w-full px-4 py-3 border-2 border-pink-200 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 font-medium transition-all">
                        {% endif %}
                        <input type="hidden" name="category_{{ setting.key }}" value="notifications">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-slate-500 text-center py-8">{% if current_lang == 'fr' %}Aucun param√®tre de notification.{% else %}No notification settings.{% endif %}</p>
                {% endif %}
            </div>
        </div>

        <!-- Security -->
        <div id="security" class="tab-content">
            <div class="bg-gradient-to-br from-slate-50 to-red-50 rounded-2xl p-8 shadow-sm border border-red-100">
                <div class="flex items-center gap-3 mb-8">
                    <span class="p-3 bg-red-600 text-white rounded-lg"><i class="fas fa-shield-alt"></i></span>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">{% if current_lang == 'fr' %}S√©curit√©{% else %}Security{% endif %}</h2>
                        <p class="text-sm text-slate-600">{% if current_lang == 'fr' %}Param√®tres de s√©curit√© importants{% else %}Important security settings{% endif %}</p>
                    </div>
                </div>

                {% if settings.security %}
                <div class="space-y-4">
                    {% for setting in settings.security %}
                    <div class="bg-white rounded-xl p-6 border-2 border-red-100 hover:border-red-300 transition-colors">
                        {% if setting.value in ['true', 'false'] %}
                        <div class="flex items-center justify-between">
                            <label for="sec_{{ setting.key }}" class="text-sm font-semibold text-slate-700 cursor-pointer">
                                {% if setting.description %}{{ setting.description }}{% else %}{{ setting.key }}{% endif %}
                            </label>
                            <input type="checkbox" id="sec_{{ setting.key }}" name="setting_{{ setting.key }}" value="true" {% if setting.value == 'true' %}checked{% endif %} class="w-5 h-5 rounded cursor-pointer">
                            <input type="hidden" name="setting_{{ setting.key }}" value="false">
                        </div>
                        {% else %}
                        <label class="block text-sm font-semibold text-slate-700 mb-3">
                            {% if setting.description %}{{ setting.description }}{% else %}{{ setting.key }}{% endif %}
                        </label>
                        <input type="text" name="setting_{{ setting.key }}" value="{{ setting.value }}" 
                               class="w-full px-4 py-3 border-2 border-red-200 rounded-lg focus:border-red-500 focus:ring-2 focus:ring-red-200 font-medium transition-all">
                        {% endif %}
                        <input type="hidden" name="category_{{ setting.key }}" value="security">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-slate-500 text-center py-8">{% if current_lang == 'fr' %}Aucun param√®tre de s√©curit√©.{% else %}No security settings.{% endif %}</p>
                {% endif %}
            </div>
        </div>

        <!-- SEO -->
        <div id="seo" class="tab-content">
            <div class="bg-gradient-to-br from-slate-50 to-indigo-50 rounded-2xl p-8 shadow-sm border border-indigo-100">
                <div class="flex items-center gap-3 mb-8">
                    <span class="p-3 bg-indigo-600 text-white rounded-lg"><i class="fas fa-search"></i></span>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">SEO {% if current_lang == 'fr' %}& Optimisation{% else %}& Optimization{% endif %}</h2>
                        <p class="text-sm text-slate-600">{% if current_lang == 'fr' %}Optimisez votre pr√©sence en ligne{% else %}Optimize your online presence{% endif %}</p>
                    </div>
                </div>

                {% if settings.seo %}
                <div class="grid md:grid-cols-2 gap-6">
                    {% for setting in settings.seo %}
                    <div class="bg-white rounded-xl p-6 border-2 border-indigo-100 hover:border-indigo-300 transition-colors">
                        <label class="block text-sm font-semibold text-slate-700 mb-3">
                            {% if setting.description %}{{ setting.description }}{% else %}{{ setting.key }}{% endif %}
                        </label>
                        {% if 'description' in setting.key or 'keywords' in setting.key %}
                        <textarea name="setting_{{ setting.key }}" rows="3" class="w-full px-4 py-3 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 font-medium transition-all resize-none">{{ setting.value }}</textarea>
                        {% else %}
                        <input type="text" name="setting_{{ setting.key }}" value="{{ setting.value }}" 
                               class="w-full px-4 py-3 border-2 border-indigo-200 rounded-lg focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 font-medium transition-all">
                        {% endif %}
                        <input type="hidden" name="category_{{ setting.key }}" value="seo">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-slate-500 text-center py-8">{% if current_lang == 'fr' %}Aucun param√®tre SEO.{% else %}No SEO settings.{% endif %}</p>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="sticky bottom-0 bg-white rounded-2xl p-6 shadow-lg border-t-2 border-gray-100 flex gap-4">
            <button type="submit" class="flex-1 py-3 px-6 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition font-semibold flex items-center justify-center gap-2 shadow-md">
                <i class="fas fa-save"></i>{{ _('save') }}
            </button>
            <button type="button" onclick="resetForm()" class="flex-1 py-3 px-6 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition font-semibold flex items-center justify-center gap-2">
                <i class="fas fa-undo"></i>{% if current_lang == 'fr' %}R√©initialiser{% else %}Reset{% endif %}
            </button>
            <form action="{{ url_for('settings.initialize') }}" method="POST" class="flex-1">
                <button type="submit" class="w-full py-3 px-6 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 transition font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-magic"></i>{% if current_lang == 'fr' %}D√©fauts{% else %}Defaults{% endif %}
                </button>
            </form>
        </div>
    </form>
</div>

<style>
    .tab-btn {
        background-color: #f1f5f9;
        color: #475569;
        border: 2px solid #e2e8f0;
    }
    
    .tab-btn.active {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    input[type="checkbox"] {
        accent-color: currentColor;
    }

    select, input[type="text"], input[type="number"], textarea {
        font-family: inherit;
    }

    .model-setting {
        display: none;
    }

    .model-setting.visible {
        display: block;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
let currentTab = 'api-status';

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('active');
    });
    
    const tabElement = document.getElementById(tabName);
    if (tabElement) {
        tabElement.classList.add('active');
    }
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    currentTab = tabName;
}

document.addEventListener('DOMContentLoaded', function() {
    switchTab('api-status');
    updateDynamicModels();
});

function updateTimeValue(fieldName) {
    const hours = document.getElementById(`${fieldName}_hours`).value || '0';
    const minutes = document.getElementById(`${fieldName}_minutes`).value || '0';
    const seconds = document.getElementById(`${fieldName}_seconds`).value || '0';
    const timeValue = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    document.getElementById(`hidden_${fieldName}`).value = timeValue;
}

function updateDynamicModels() {
    const selectedModel = document.getElementById('default_ai_model_select').value;
    const modelSettings = document.querySelectorAll('.model-setting');
    
    modelSettings.forEach(setting => {
        const dataModel = setting.getAttribute('data-model');
        if (dataModel === 'all' || dataModel === selectedModel) {
            setting.classList.add('visible');
        } else {
            setting.classList.remove('visible');
        }
    });
}

function resetForm() {
    if (confirm('{% if current_lang == "fr" %}√ätes-vous s√ªr de vouloir r√©initialiser ?{% else %}Are you sure you want to reset?{% endif %}')) {
        document.querySelector('form').reset();
    }
}

function testApi(apiType) {
    const resultDiv = document.getElementById('testResult');
    const icon = document.getElementById('testIcon');
    const message = document.getElementById('testMessage');
    const details = document.getElementById('testDetails');
    
    resultDiv.classList.remove('hidden');
    icon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>';
    icon.className = 'w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 bg-blue-100';
    message.textContent = '{% if current_lang == "fr" %}Test en cours...{% else %}Testing...{% endif %}';
    details.textContent = '';
    
    let url;
    if (apiType === 'gemini') {
        url = '{{ url_for("settings.test_gemini") }}';
    } else if (apiType === 'perplexity') {
        url = '{{ url_for("settings.test_perplexity") }}';
    } else if (apiType === 'openai') {
        url = '{{ url_for("settings.test_openai") }}';
    } else if (apiType === 'openrouter') {
        url = '{{ url_for("settings.test_openrouter") }}';
    } else if (apiType === 'eleven_labs') {
        url = '{{ url_for("settings.test_elevenlabs") }}';
    } else if (apiType === 'telegram') {
        url = '{{ url_for("settings.test_telegram") }}';
    }
    
    if (!url) {
        icon.innerHTML = '<i class="fas fa-times text-red-500 text-2xl"></i>';
        icon.className = 'w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 bg-red-100';
        message.textContent = '{% if current_lang == "fr" %}Erreur{% else %}Error{% endif %}';
        details.textContent = 'API endpoint not found';
        return;
    }
    
    fetch(url, { method: 'POST' })
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(data => {
            if (data.success) {
                icon.innerHTML = '<i class="fas fa-check text-green-500 text-2xl"></i>';
                icon.className = 'w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 bg-green-100';
                message.textContent = data.message;
                if (data.response) {
                    details.textContent = data.response;
                }
            } else {
                icon.innerHTML = '<i class="fas fa-times text-red-500 text-2xl"></i>';
                icon.className = 'w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 bg-red-100';
                message.textContent = '{% if current_lang == "fr" %}Erreur{% else %}Error{% endif %}';
                details.textContent = data.message;
            }
        })
        .catch(err => {
            icon.innerHTML = '<i class="fas fa-times text-red-500 text-2xl"></i>';
            icon.className = 'w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 bg-red-100';
            message.textContent = '{% if current_lang == "fr" %}Erreur de connexion{% else %}Connection error{% endif %}';
            details.textContent = err.message;
        });
}
</script>
{% endblock %}
